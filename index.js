(function(){"use strict";function a(t,e,s,n,r,c,d,Re){var i=typeof t=="function"?t.options:t;e&&(i.render=e,i.staticRenderFns=s,i._compiled=!0),n&&(i.functional=!0),c&&(i._scopeId="data-v-"+c);var l;if(d?(l=function(o){o=o||this.$vnode&&this.$vnode.ssrContext||this.parent&&this.parent.$vnode&&this.parent.$vnode.ssrContext,!o&&typeof __VUE_SSR_CONTEXT__<"u"&&(o=__VUE_SSR_CONTEXT__),r&&r.call(this,o),o&&o._registeredComponents&&o._registeredComponents.add(d)},i._ssrRegister=l):r&&(l=Re?function(){r.call(this,(i.functional?this.parent:this).$root.$options.shadowRoot)}:r),l)if(i.functional){i._injectStyles=l;var Ee=i.render;i.render=function(Ve,v){return l.call(v),Ee(Ve,v)}}else{var u=i.beforeCreate;i.beforeCreate=u?[].concat(u,l):[l]}return{exports:t,options:i}}const _={props:{changes:Object},computed:{markedChangesForStaging(){return this.$store.state.versions.data.markedChangesForStaging}},mounted(){for(const t in this.changes)this.$store.dispatch("versions/setChanges",{path:t,status:this.changes[t]})},methods:{updateChange(t,e,s){this.$store.dispatch("versions/setChanges",{path:t,status:s?e:!1})}}};var h=function(){var e=this,s=e._self._c;return s("ul",{staticClass:"lbvs-changes"},e._l(e.changes,function(n,r){return s("li",{key:r},[s("div",[s("k-input",{attrs:{id:r,name:r,value:n,checked:n!==!1,type:"checkbox"},on:{input:c=>e.updateChange(r,n,c)}})],1),s("span",{attrs:{"data-status":n,title:e.$t("versions.label.status."+n)}},[e._v(" "+e._s(n)+" ")]),s("label",{attrs:{for:r}},[e._v(e._s(r))])])}),0)},f=[],b=a(_,h,f,!1,null,null,null,null);const p=b.exports,g={props:{toStage:Object}};var m=function(){var e=this,s=e._self._c;return s("ul",{staticClass:"lbvs-changes"},e._l(e.toStage,function(n,r){return s("li",{key:r},[s("span",{attrs:{"data-status":n,title:e.$t("versions.label.status."+n)}},[e._v(" "+e._s(n)+" ")]),e._v(" "+e._s(r)+" ")])}),0)},$=[],y=a(g,m,$,!1,null,null,null,null);const C=y.exports,k={data(){return{error:{message:null,details:{lockedModels:{}}}}},methods:{open(t){this.error=t,this.$refs.dialog.open()}}};var S=function(){var e=this,s=e._self._c;return s("k-dialog",{ref:"dialog",staticClass:"lbvs-create-error-dialog",attrs:{"cancel-button":e.$t("close"),"submit-button":!1}},[s("p",{staticClass:"lbvs-create-error-dialog-message"},[e._v(" "+e._s(e.error.message)+" ")]),s("ul",{staticClass:"lbvs-create-error-dialog-list"},e._l(e.error.details.lockedModels,function(n,r){return s("li",{key:r},[e._v(" "+e._s(r)+" "),s("span",[e._v("("+e._s(n.join(", "))+")")])])}),0)])},w=[],x=a(k,S,w,!1,null,null,null,null);const D=x.exports,T={data(){return{instance:null,inProgress:!1,toStage:{}}},computed:{fields(){return{label:{autofocus:!0,icon:"title",label:this.$t("versions.label.label"),type:"text"}}}},methods:{async onSubmit(){if(this.inProgress!==!0)try{this.inProgress=!0;let t=this.$refs.form.value.label;if(!t)throw this.$t("field.required");await this.$store.dispatch({type:"versions/addChangesToStage",changes:this.toStage}),await this.$store.dispatch({type:"versions/createVersion",instance:this.instance,label:t}),this.$store.dispatch("notification/success",":)"),this.$refs.dialog.close()}catch(t){this.$refs.dialog.error(t.message||t)}finally{this.inProgress=!1}},open(t,e){this.instance=t,this.toStage=e,this.$refs.dialog.open()}}};var F=function(){var e=this,s=e._self._c;return s("div",[s("k-dialog",{ref:"dialog",attrs:{size:"large","submit-button":e.$t("versions.button.create"),theme:"positive"},on:{submit:e.onSubmit}},[s("k-form",{ref:"form",attrs:{fields:e.fields},on:{submit:e.onSubmit},scopedSlots:e._u([{key:"header",fn:function(){return[s("k-field",{staticClass:"lbvs-create-changes",attrs:{label:e.$t("versions.label.changes")}},[s("lbvs-stages",{attrs:{"to-stage":e.toStage}})],1)]},proxy:!0}])})],1),s("lbvs-create-error-dialog",{ref:"errorDialog"})],1)},R=[],E=a(T,F,R,!1,null,null,null,null);const V=E.exports,A={data(){return{inProgress:!1,version:null}},methods:{async onSubmit(){if(this.inProgress!==!0)try{this.inProgress=!0,await this.$store.dispatch({type:"versions/deleteVersion",version:this.version.name}),this.$store.dispatch("notification/success",":)"),this.$refs.dialog.close()}catch(t){this.$refs.dialog.error(t.message||t)}finally{this.inProgress=!1}},open(t){this.version=t,this.$refs.dialog.open()}}};var O=function(){var e=this,s=e._self._c;return s("k-dialog",{ref:"dialog",staticClass:"lbvs-version-dialog lbvs-version-delete-dialog",attrs:{icon:"trash","submit-button":e.$t("versions.button.delete"),theme:"negative"},on:{submit:e.onSubmit}},[e.version?s("lbvs-version",{attrs:{version:e.version}}):e._e(),s("p",[e._v(e._s(e.$t("versions.message.delete")))])],1)},j=[],P=a(A,O,j,!1,null,null,null,null);const I=P.exports,N={data(){return{inProgress:!1,version:null}},computed:{fields(){let t=this.$store.getters["versions/currentInstance"],e=Object.values(this.$store.state.versions.data.instances).map(s=>({text:s.name,value:s.name}));return{instance:{disabled:e.length<=1,empty:!1,icon:"box",label:this.$t("versions.label.targetInstance"),options:e,placeholder:t.name,type:"select",value:t.name}}}},methods:{async onSubmit(){if(this.inProgress!==!0)try{this.inProgress=!0;let t=this.$refs.form.value.instance||this.$store.getters["versions/currentInstance"].name;await this.$store.dispatch({type:"versions/deployVersion",version:this.version.name,instance:t}),this.$store.dispatch("notification/success",":)"),this.$refs.dialog.close()}catch(t){this.$refs.dialog.error(t.message||t)}finally{this.inProgress=!1}},open(t){this.version=t,this.$refs.dialog.open()}}};var L=function(){var e=this,s=e._self._c;return s("k-dialog",{ref:"dialog",staticClass:"lbvs-version-dialog",attrs:{"submit-button":e.$t("versions.button.deploy"),theme:"positive"},on:{submit:e.onSubmit}},[e.version?s("lbvs-version",{attrs:{version:e.version}}):e._e(),s("k-form",{ref:"form",attrs:{fields:e.fields},on:{submit:e.onSubmit}})],1)},M=[],H=a(N,L,M,!1,null,null,null,null);const z=H.exports,G={data(){return{data:null,version:{}}},computed:{details(){return this.data?[{title:this.$t("versions.label.fileSize"),value:this.data.filesize}]:[]},supportsClipboard(){try{return window.navigator.clipboard.writeText,!0}catch{return!1}}},methods:{async copyToClipboard(){await window.navigator.clipboard.writeText(this.data.url),this.$store.dispatch("notification/success",":)")},download(){window.location=this.data.url,this.$store.dispatch("notification/success",":)")},async open(t){this.data=null,this.version=t,this.$refs.dialog.open();let e=await this.$store.dispatch({type:"versions/exportVersion",version:this.version.name});t===this.version&&(this.data=e)}}};var Y=function(){var e=this,s=e._self._c;return s("k-dialog",{ref:"dialog",staticClass:"lbvs-version-dialog",attrs:{"cancel-button":e.$t(e.data?"close":"cancel"),"submit-button":!1}},[e.version?s("lbvs-version",{attrs:{details:e.details,version:e.version}}):e._e(),e.data?s("k-button-group",[s("k-button",{attrs:{icon:"download"},on:{click:e.download}},[e._v(" "+e._s(e.$t("versions.button.download"))+" ")]),s("k-button",{attrs:{icon:"copy",disabled:!e.supportsClipboard},on:{click:e.copyToClipboard}},[e._v(" "+e._s(e.$t("versions.button.copyLink"))+" ")])],1):s("p",[e._v(" "+e._s(e.$t("versions.message.exporting"))+" ")])],1)},B=[],U=a(G,Y,B,!1,null,null,null,null);const X=U.exports,q={props:{inline:Boolean,instance:[Object,String]},computed:{element(){return this.inline?"span":"strong"},instanceObj(){return typeof this.instance=="string"?{name:this.instance,color:"var(--color-gray-300)"}:this.instance}}};var W=function(){var e=this,s=e._self._c;return s(e.element,{tag:"component",staticClass:"lbvs-instance-name",style:{backgroundColor:e.instanceObj.color}},[e._v(" "+e._s(e.instanceObj.name)+" ")])},J=[],K=a(q,W,J,!1,null,null,null,null);const Q=K.exports,Z={props:{value:[Array,String]},computed:{instances(){return Array.isArray(this.value)?this.value:[this.value]}}};var ee=function(){var e=this,s=e._self._c;return s("div",{staticClass:"lbvs-instance-names-cell"},e._l(e.instances,function(n){return s("lbvs-instance-name",{key:n,attrs:{inline:!0,instance:e.$store.state.versions.data.instances[n]||n}})}),1)},se=[],te=a(Z,ee,se,!1,null,null,null,null);const ne=te.exports,re={computed:{canCreateVersion(){return this.$permissions["lukasbestle.versions"].create===!0&&Object.keys(this.currentChanges).length>0},currentChanges(){return this.$store.getters["versions/currentInstance"].changes}},methods:{onCreate(){let t=this.$store.getters["versions/currentInstance"].name;const e=this.$store.getters["versions/currentChanges"];return this.$refs.createDialog.open(t,e)}}};var ae=function(){var e=this,s=e._self._c;return s("div",{staticClass:"lbvs-status"},[s("k-view",[s("k-grid",[s("k-column",{attrs:{width:"1/3"}},[s("header",{staticClass:"k-section-header"},[s("k-label",{attrs:{type:"section"}},[e._v(" "+e._s(e.$t("versions.label.instances"))+" ")])],1),s("ul",{staticClass:"lbvs-status-instances"},e._l(e.$store.state.versions.data.instances,function(n){return s("li",{key:n.name,class:{current:n.isCurrent}},[s("lbvs-instance-name",{attrs:{instance:n}}),n.isCurrent?s("span",{staticClass:"lbvs-status-current"},[e._v(" "+e._s(e.$t("versions.label.current"))+" ")]):e._e(),n.version?s("lbvs-version",{attrs:{version:{name:n.version,label:n.versionLabel}}}):e._e()],1)}),0)]),s("k-column",{staticClass:"lbvs-status-changes",attrs:{width:"2/3"}},[s("header",{staticClass:"k-section-header"},[s("k-label",{attrs:{type:"section"}},[e._v(" "+e._s(e.$t("versions.label.changes"))+" ")]),s("k-button",{attrs:{icon:"add",size:"xs",disabled:e.canCreateVersion===!1},on:{click:e.onCreate}},[e._v(" "+e._s(e.$t("versions.button.create"))+" ")])],1),s("lbvs-changes",{attrs:{changes:e.currentChanges}})],1)],1)],1),s("lbvs-create-dialog",{ref:"createDialog"})],1)},ie=[],oe=a(re,ae,ie,!1,null,null,null,null);const le=oe.exports,ce={props:{details:{type:Array,default(){return[]}},instances:Boolean,version:Object},computed:{mergedDetails(){return[{title:this.$t("versions.label.versionName"),value:this.version.name},...this.details].filter(e=>e.value)}}};var de=function(){var e=this,s=e._self._c;return s("div",{staticClass:"lbvs-version"},[s("strong",[e._v(e._s(e.version.label))]),s("dl",{staticClass:"lbvs-version-details"},[e._l(e.mergedDetails,function(n){return[s("dt",{key:n.title,staticClass:"sr-only"},[e._v(e._s(n.title)+":")]),s("dd",{key:n.title,attrs:{title:n.title}},[e._v(" "+e._s(n.value)+" ")])]})],2)])},ue=[],ve=a(ce,de,ue,!1,null,null,null,null);const _e=ve.exports,he={props:{value:Object}};var fe=function(){var e=this,s=e._self._c;return s("div",{staticClass:"lbvs-version-label-cell"},[s("lbvs-version",{attrs:{version:e.value}})],1)},be=[],pe=a(he,fe,be,!1,null,null,null,null);const ge=pe.exports,me={computed:{columns(){return{title:{label:this.$t("versions.label.label"),type:"lbvs-version-label",mobile:!0,width:"35%"},instances:{label:this.$t("versions.label.instances"),type:"lbvs-instance-names",mobile:!0,width:"25%"},creation:{label:this.$t("versions.label.creation"),type:"text",width:"25%"},originInstance:{label:this.$t("versions.label.originInstance"),type:"lbvs-instance-names",width:"15%"}}},items(){return Object.values(this.$store.state.versions.data.versions).map(t=>(t.creation=this.$t("versions.label.creationData",{created:t.created?this.$library.dayjs.unix(t.created).format("YYYY-MM-DD HH:mm"):"?",creator:t.creatorName||t.creatorEmail||"?"}),t.title={label:t.label,name:t.name},t.options=this.options(t),t))}},methods:{onOption(t,e){return this.$refs[t+"Dialog"].open(e)},options(t){let e=this.$permissions["lukasbestle.versions"];return[{click:"export",disabled:e.export!==!0,icon:"download",text:this.$t("versions.button.export")},{click:"deploy",disabled:e.deploy!==!0,icon:"wand",text:this.$t("versions.button.deploy")},{click:"delete",disabled:e.delete!==!0||t.instances.length>0,icon:"trash",text:this.$t("versions.button.delete")}]}}};var $e=function(){var e=this,s=e._self._c;return s("div",{staticClass:"lbvs-versions"},[s("header",{staticClass:"k-section-header"},[s("k-label",{attrs:{type:"section"}},[e._v(" "+e._s(e.$t("versions.label.versions"))+" ")])],1),e.items.length?s("k-items",{attrs:{columns:e.columns,items:e.items,layout:"table",sortable:!1},on:{option:e.onOption}}):s("k-empty",{attrs:{icon:"protected",layout:"table"}},[e._v(" "+e._s(e.$t("versions.label.empty"))+" ")]),s("lbvs-export-dialog",{ref:"exportDialog"}),s("lbvs-deploy-dialog",{ref:"deployDialog"}),s("lbvs-delete-dialog",{ref:"deleteDialog"})],1)},ye=[],Ce=a(me,$e,ye,!1,null,null,null,null);const ke=Ce.exports,Se={data(){return{isLoading:!0}},async mounted(){this.$permissions["lukasbestle.versions"].access!==!0&&this.$go("/");try{this.isLoading=!0,await this.$store.dispatch("versions/load")}finally{this.isLoading=!1}}};var we=function(){var e=this,s=e._self._c;return s("k-inside",[s("div",{staticClass:"lbvs-view"},[e.isLoading?s("k-loader"):[s("lbvs-status"),s("lbvs-versions")]],2)])},xe=[],De=a(Se,we,xe,!1,null,null,null,null);const Te=De.exports,Fe=t=>({namespaced:!0,state:{data:{markedChangesForStaging:{},instances:{},versions:{}}},getters:{currentInstance(e){return Object.values(e.data.instances).find(s=>s.isCurrent)},currentChanges(e){return e.data.markedChangesForStaging}},mutations:{SET_DATA(e,{instances:s,versions:n}){e.data.instances=s,e.data.versions=n},SET_CHANGES(e,{path:s,status:n}){e.data.markedChangesForStaging[s]=n},REMOVE_CHANGES(e,{path:s}){delete e.data.markedChangesForStaging[s]}},actions:{async load({commit:e}){e("SET_DATA",await t.$api.get("versions"))},async prepareVersionCreation(e,{instance:s}){return await t.$api.post("versions/prepareCreation",{instance:s})},async addChangesToStage({commit:e},{changes:s}){await t.$api.post("versions/addChanges",{changes:s})},async createVersion({commit:e},{instance:s,label:n}){let r=await t.$api.post("versions/create",{instance:s,label:n});e("SET_DATA",r)},async deleteVersion({commit:e},{version:s}){let n=await t.$api.delete("versions/versions/"+s);e("SET_DATA",n)},async deployVersion({commit:e},{instance:s,version:n}){let r=await t.$api.post("versions/versions/"+n+"/deploy",{instance:s});e("SET_DATA",r)},async exportVersion(e,{version:s}){return await t.$api.post("versions/versions/"+s+"/export")},setChanges({commit:e},{path:s,status:n}){if(n===!1){e("REMOVE_CHANGES",{path:s});return}return e("SET_CHANGES",{path:s,status:n})}}});panel.plugin("lukasbestle/versions",{components:{"k-table-lbvs-instance-names-cell":ne,"k-table-lbvs-version-label-cell":ge,"lbvs-changes":p,"lbvs-stages":C,"lbvs-create-error-dialog":D,"lbvs-create-dialog":V,"lbvs-delete-dialog":I,"lbvs-deploy-dialog":z,"lbvs-export-dialog":X,"lbvs-instance-name":Q,"lbvs-status":le,"lbvs-version":_e,"lbvs-versions":ke,"lbvs-view":Te},created(t){t.$store.registerModule("versions",Fe(t))}})})();
